<!DOCTYPE html>
<html lang="en" class="height-full" data-color-mode="auto" data-light-theme="light" data-dark-theme="dark">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta http-equiv="X-UA-Compatible" content="ie=edge">
      <title>Terrateam Setup - Success</title>
      <link rel="icon" href="/probot/static/logo.svg">
      <link rel="stylesheet" href="/probot/static/primer.css">
      <link rel="stylesheet" href="/probot/static/terrateam-setup.css">
   </head>
   <body>
      <div class="setup-container">
         <div class="setup-card">
            <img src="/probot/static/logo.svg" alt="Terrateam Logo" class="logo">
            <h1 class="success-title">Success!</h1>
            <h2 class="success-subtitle">Your GitHub Application has been created</h2>
            <div class="progress-indicator">
               <div class="progress-step completed">1. Welcome</div>
               <div class="progress-step completed">2. Choose VCS</div>
               <div class="progress-step completed">3. Configure Access</div>
               <div class="progress-step completed">4. Create App</div>
               <div class="progress-step active">5. Complete</div>
            </div>
            
            <div class="next-steps-section">
               <div class="next-steps-title">What to do next:</div>
               <div class="next-steps-list">
                  <div class="next-steps-item step-item" data-step="1">
                     <div class="step-header" onclick="toggleStep(1)">
                        <div class="step-number">1</div>
                        <div class="step-title-text">Important Setup Warning</div>
                        <div class="step-chevron">▼</div>
                     </div>
                     <div class="step-content" id="step-1-content">
                        <div class="step-description">
                           <div class="warning-inline-step">
                              ⚠️ <strong>Important:</strong> Don't install the GitHub app on any repositories yet! First, complete all the steps below to deploy your Terrateam server and configure the UI. The Getting Started wizard in the Terrateam UI will guide you through installing the app on your repositories.
                           </div>
                        </div>
                        <button class="next-step-btn" onclick="completeStep(1)">Next</button>
                     </div>
                  </div>
                  <div class="next-steps-item step-item" data-step="2">
                     <div class="step-header" onclick="toggleStep(2)">
                        <div class="step-number">2</div>
                        <div class="step-title-text">Copy these settings to your .env file (next to your docker-compose.yml)</div>
                        <div class="step-chevron">▶</div>
                     </div>
                     <div class="step-content" id="step-2-content" style="display: none;">
                        <div class="step-description">
                           <strong>Copy these settings to your `.env` file</strong>
                           <div class="sub-note" style="margin-top: 10px;">This `.env` file should be placed in the same directory as your Terrateam `docker-compose.yml` file.</div>
                           <div class="env-inline-section">
                              <textarea id="env" class="env-textarea">{{ env_file }}</textarea>
                              <button id="copyToClipboard" class="copy-btn">Copy to Clipboard</button>
                           </div>
                        </div>
                        <button class="next-step-btn" onclick="completeStep(2)">Next</button>
                     </div>
                  </div>
                  <div class="next-steps-item step-item" data-step="3">
                     <div class="step-header" onclick="toggleStep(3)">
                        <div class="step-number">3</div>
                        <div class="step-title-text">Deploy the Terrateam Server</div>
                        <div class="step-chevron">▶</div>
                     </div>
                     <div class="step-content" id="step-3-content" style="display: none;">
                        <div class="step-description">
                           <strong>Deploy the Terrateam Server</strong>
                           
                           <!-- Deployment method selection -->
                           <div class="deployment-method-section">
                              <div class="deployment-method-title">Choose your deployment method:</div>
                              <div class="deployment-method-options">
                                 <label class="deployment-option">
                                    <input type="radio" name="deployment-method" value="docker-compose" checked onchange="showDeploymentInstructions()">
                                    <span class="deployment-option-text">Docker Compose (Development/Testing)</span>
                                 </label>
                                 <label class="deployment-option">
                                    <input type="radio" name="deployment-method" value="production" onchange="showDeploymentInstructions()">
                                    <span class="deployment-option-text">Production Deployment (Kubernetes, ECS, etc.)</span>
                                 </label>
                              </div>
                           </div>

                           <!-- Docker Compose Instructions -->
                           <div id="docker-compose-instructions" class="deployment-instructions">
                              <div class="sub-steps">
                                 <div class="sub-step">
                                    <strong>Stop the setup container:</strong> Press <code>Ctrl+C</code> in the terminal to stop the container
                                    <div class="warning-inline">⚠️ Keep this browser window open for the remaining steps!</div>
                                 </div>
                                 <div class="sub-step">
                                    <strong>Start the Terrateam Server:</strong> Run the following command:
                                    <div class="code-block">
                                       <button class="code-copy-btn" onclick="copyCodeBlock(this)">Copy</button>
                                       <code>docker-compose up -d server</code>
                                    </div>
                                 </div>
                                 <div class="sub-step">
                                    <strong>Wait for the server:</strong> The command will return to your shell when the server is ready
                                 </div>
                              </div>
                           </div>

                           <!-- Production Deployment Instructions -->
                           <div id="production-instructions" class="deployment-instructions" style="display: none;">
                              <div class="production-deployment-info">
                                 <div class="production-info-box">
                                    <h4>Production Deployment</h4>
                                    <p>For production deployments using Kubernetes, ECS, or other infrastructure, please refer to our comprehensive deployment documentation.</p>
                                    
                                    <div class="production-requirements">
                                       <strong>Your deployment will need:</strong>
                                       <ul>
                                          <li>The environment variables from Step 2</li>
                                          <li>A publicly accessible HTTPS endpoint</li>
                                          <li>The Terrateam server running and healthy</li>
                                       </ul>
                                    </div>
                                    
                                    <div class="documentation-link-section">
                                       <a href="https://docs.terrateam.io/self-hosted" target="_blank" class="docs-link-btn">
                                          View Production Deployment Guide
                                       </a>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>
                        <button class="next-step-btn" onclick="completeStep(3)">Next</button>
                     </div>
                  </div>
                  <div class="next-steps-item step-item" data-step="4">
                     <div class="step-header" onclick="toggleStep(4)">
                        <div class="step-number">4</div>
                        <div class="step-title-text">Enable Terrateam UI Access</div>
                        <div class="step-chevron">▶</div>
                     </div>
                     <div class="step-content" id="step-4-content" style="display: none;">
                        <div class="step-description">
                           <strong>Enable Terrateam UI Access</strong>
                           <ol style="margin-left: 20px; margin-top: 10px;">
                              <li>Navigate to your GitHub App: <a href="{{ html_url }}" target="_blank" class="app-link">{{ html_url }}</a></li>
                              <li>Click on "App settings" on the right side under the Install button</li>
                              <li>Check the box "Request user authorization (OAuth) during installation"</li>
                              <li>Set the callback URL to:
                                 <div class="code-block" style="margin: 10px 0;">
                                    <button class="code-copy-btn" onclick="copyCodeBlock(this)">Copy</button>
                                    <code>{{ tunnelUrl }}/api/github/v1/callback</code>
                                 </div>
                              </li>
                              <li>Save your changes</li>
                           </ol>
                           <div class="sub-note">
                              <strong>Access your Terrateam UI:</strong> After configuring OAuth, access the UI at:
                              <div class="code-block" style="margin: 10px 0;">
                                 <button class="code-copy-btn" onclick="copyCodeBlock(this)">Copy</button>
                                 <code>{{ tunnelUrl }}</code>
                              </div>
                           </div>
                        </div>
                        <button class="next-step-btn" onclick="completeStep(4)">Next</button>
                     </div>
                  </div>
                  <div class="next-steps-item step-item" data-step="5">
                     <div class="step-header" onclick="toggleStep(5)">
                        <div class="step-number">5</div>
                        <div class="step-title-text">Complete Setup in Terrateam UI</div>
                        <div class="step-chevron">▶</div>
                     </div>
                     <div class="step-content" id="step-5-content" style="display: none;">
                        <div class="step-description">
                           <strong>Complete Setup in Terrateam UI</strong>
                           <div class="sub-steps">
                              <div class="sub-step">
                                 <strong>Access the Terrateam UI:</strong>
                                 <div class="code-block" style="margin: 10px 0;">
                                    <button class="code-copy-btn" onclick="copyCodeBlock(this)">Copy</button>
                                    <code>{{ tunnelUrl }}</code>
                                 </div>
                              </div>
                              <div class="sub-step">
                                 <strong>Follow the Getting Started wizard:</strong> The UI will guide you through:
                                 <ul style="margin-left: 20px; margin-top: 10px;">
                                    <li>Installing the GitHub app on your repositories</li>
                                    <li>Adding the Terrateam workflow to your repos</li>
                                    <li>Creating your first pull request</li>
                                    <li>Monitoring your infrastructure changes</li>
                                 </ul>
                              </div>
                              <div class="sub-note">
                                 <strong>Note:</strong> Make sure you've completed step 4 (Enable Terrateam UI Access) before accessing the UI.
                              </div>
                           </div>
                        </div>
                        <button class="next-step-btn" onclick="completeStep(5)">Complete Setup</button>
                     </div>
                  </div>
               </div>
            </div>
            <div class="completion-section" id="completion-section" style="display: none;">
               <div class="completion-message">
                  <h3>Setup Complete!</h3>
                  <p>You've successfully completed all setup steps. Terrateam is now ready to use!</p>
               </div>
            </div>
            <a href="https://terrateam.io/slack" target="_blank" class="back-to-docs-btn">Need help? Join us on Slack</a>
         </div>
         <div class="support-section">
            <h4 class="support-title">Support</h4>
            <div class="support-links">
               <a href="https://terrateam.io/docs/" class="support-link">Docs</a>
               <a href="https://terrateam.io/slack" class="support-link">Slack</a>
               <a href="https://github.com/terrateamio/terrateam" class="support-link">GitHub</a>
               <a href="mailto:support@terrateam.io" class="support-link">Email</a>
            </div>
         </div>
      </div>
      
      <!-- Fixed help link -->
      <div class="fixed-help">
         <a href="https://terrateam.io/slack" class="fixed-help-link" target="_blank">
            Need help? Join Slack
         </a>
      </div>
      
      <script>
         // State management for steps
         let currentStep = 1;
         let completedSteps = [];
         const totalSteps = 5;
         
         // Initialize on page load
         document.addEventListener('DOMContentLoaded', function() {
            loadState();
            updateStepVisibility();
            setupCopyButton();
         });
         
         // Function to reset setup state (for debugging)
         function resetSetupState() {
            localStorage.removeItem('terrateam-setup-state');
            currentStep = 1;
            completedSteps = [];
            updateStepVisibility();
         }
         
         // Load state from localStorage
         function loadState() {
            const savedState = localStorage.getItem('terrateam-setup-state');
            if (savedState) {
               const state = JSON.parse(savedState);
               currentStep = state.currentStep || 1;
               completedSteps = state.completedSteps || [];
            }
         }
         
         // Save state to localStorage
         function saveState() {
            const state = {
               currentStep: currentStep,
               completedSteps: completedSteps
            };
            localStorage.setItem('terrateam-setup-state', JSON.stringify(state));
         }
         
         // Toggle step visibility (only one open at a time)
         function toggleStep(stepNumber) {
            const content = document.getElementById(`step-${stepNumber}-content`);
            const chevron = document.querySelector(`[data-step="${stepNumber}"] .step-chevron`);
            
            // Close all other steps first
            for (let i = 1; i <= totalSteps; i++) {
               if (i !== stepNumber) {
                  const otherContent = document.getElementById(`step-${i}-content`);
                  const otherChevron = document.querySelector(`[data-step="${i}"] .step-chevron`);
                  otherContent.style.display = 'none';
                  otherChevron.textContent = '▶';
               }
            }
            
            // Toggle the clicked step
            if (content.style.display === 'none') {
               content.style.display = 'block';
               chevron.textContent = '▼';
            } else {
               content.style.display = 'none';
               chevron.textContent = '▶';
            }
         }
         
         // Complete a step and move to next
         function completeStep(stepNumber) {
            if (!completedSteps.includes(stepNumber)) {
               completedSteps.push(stepNumber);
            }
            
            // Mark step as completed visually
            const stepItem = document.querySelector(`[data-step="${stepNumber}"]`);
            if (stepItem) {
               stepItem.classList.add('completed');
            }
            
            if (stepNumber < totalSteps) {
               currentStep = stepNumber + 1;
               // Collapse current step and expand next
               toggleStep(stepNumber);
               toggleStep(currentStep);
            } else {
               // Close all steps first, including final step
               for (let i = 1; i <= totalSteps; i++) {
                  const content = document.getElementById(`step-${i}-content`);
                  const chevron = document.querySelector(`[data-step="${i}"] .step-chevron`);
                  if (content) {
                     content.style.display = 'none';
                     content.style.visibility = 'hidden';
                     content.style.height = '0';
                     content.style.overflow = 'hidden';
                  }
                  if (chevron) {
                     chevron.textContent = '▶';
                  }
               }
               
               // Show completion section
               const completionSection = document.getElementById('completion-section');
               
               if (completionSection) {
                  completionSection.style.display = 'block';
                  completionSection.style.background = '#DCFCE7';
                  completionSection.style.border = '3px solid #48bb78';
                  completionSection.style.marginTop = '2rem';
                  completionSection.style.padding = '3rem';
                  completionSection.style.fontSize = '1.5rem';
                  
                  // Force a reflow to ensure the changes are applied
                  completionSection.offsetHeight;
                  
                  // Scroll to completion section with a delay to ensure it's rendered
                  setTimeout(() => {
                     window.scrollTo({
                        top: completionSection.offsetTop - 100,
                        behavior: 'smooth'
                     });
                  }, 100);
               }
            }
            
            saveState();
            updateStepVisibility();
         }
         
         // Update step visibility based on current state
         function updateStepVisibility() {
            for (let i = 1; i <= totalSteps; i++) {
               const stepItem = document.querySelector(`[data-step="${i}"]`);
               const content = document.getElementById(`step-${i}-content`);
               const chevron = document.querySelector(`[data-step="${i}"] .step-chevron`);
               
               if (completedSteps.includes(i)) {
                  stepItem.classList.add('completed');
               }
               
               if (i === currentStep) {
                  content.style.display = 'block';
                  chevron.textContent = '▼';
               } else {
                  content.style.display = 'none';
                  chevron.textContent = '▶';
               }
            }
            
            // Show completion if all steps are done
            if (completedSteps.length === totalSteps) {
               document.getElementById('completion-section').style.display = 'block';
            }
         }
         
         // Setup copy button functionality
         function setupCopyButton() {
            const copyBtn = document.getElementById('copyToClipboard');
            if (copyBtn) {
               copyBtn.addEventListener('click', function() {
                  const textArea = document.getElementById('env');
                  
                  // Select and copy the text
                  textArea.select();
                  textArea.setSelectionRange(0, 99999); // For mobile devices
                  
                  try {
                     document.execCommand('copy');
                     copyBtn.textContent = 'Copied!';
                     copyBtn.classList.add('copied');
                     
                     // Reset button after 2 seconds
                     setTimeout(() => {
                        copyBtn.textContent = 'Copy to Clipboard';
                        copyBtn.classList.remove('copied');
                     }, 2000);
                  } catch (err) {
                     console.error('Failed to copy text: ', err);
                  }
                  
                  // Clear selection
                  window.getSelection().removeAllRanges();
               });
            }
         }

         function copyCodeBlock(button) {
            const codeBlock = button.parentNode;
            const code = codeBlock.querySelector('code');
            const text = code.textContent;
            
            // Create a temporary textarea to copy the text
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
               document.execCommand('copy');
               button.textContent = 'Copied!';
               button.classList.add('copied');
               
               // Reset button after 2 seconds
               setTimeout(() => {
                  button.textContent = 'Copy';
                  button.classList.remove('copied');
               }, 2000);
            } catch (err) {
               console.error('Failed to copy code: ', err);
            }
            
            document.body.removeChild(textarea);
         }

         // Show/hide deployment instructions based on selected method
         function showDeploymentInstructions() {
            const selectedMethod = document.querySelector('input[name="deployment-method"]:checked').value;
            const dockerInstructions = document.getElementById('docker-compose-instructions');
            const productionInstructions = document.getElementById('production-instructions');
            
            if (selectedMethod === 'docker-compose') {
               dockerInstructions.style.display = 'block';
               productionInstructions.style.display = 'none';
            } else {
               dockerInstructions.style.display = 'none';
               productionInstructions.style.display = 'block';
            }
         }
      </script>
   </body>
</html>
