<!DOCTYPE html>
<html lang="en" class="height-full" data-color-mode="auto" data-light-theme="light" data-dark-theme="dark">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta http-equiv="X-UA-Compatible" content="ie=edge">
      <title>Terrateam Setup - Create GitHub App</title>
      <link rel="icon" href="/probot/static/logo.svg">
      <link rel="stylesheet" href="/probot/static/primer.css">
      <link rel="stylesheet" href="/probot/static/terrateam-setup.css">
   </head>
   <body>
      <div class="setup-container">
         <div class="setup-card">
            <img src="/probot/static/logo.svg" alt="Terrateam Logo" class="logo">
            <h1 class="app-setup-title">Create <span id="vcs-app-name">GitHub</span> App</h1>
            <h2 class="setup-subtitle">Let's create your private <span id="vcs-app-name2">GitHub</span> app</h2>
            <div class="progress-indicator">
               <div class="progress-step completed">1. Welcome</div>
               <div class="progress-step completed">2. Choose VCS</div>
               <div class="progress-step completed">3. Configure Access</div>
               <div class="progress-step active">4. Create App</div>
               <div class="progress-step">5. Complete</div>
            </div>
            <p class="setup-description">This will enable Terrateam to work with your repositories.</p>
            <div class="divider"></div>
               
            <div class="form-section">
               <label for="vcs-org" class="form-label"><span id="vcs-org-label">GitHub</span> Organization <span class="optional-text">(optional)</span></label>
               <input type="text" id="vcs-org" name="vcs-org" class="form-input" placeholder="Leave blank for personal account" value="{{ orgName }}">
               
               <div class="checkbox-container">
                  <input type="checkbox" id="onboarding-call" name="onboarding-call" class="checkbox-input" checked>
                  <label for="onboarding-call" class="checkbox-label">
                     <strong>Opt in to a free technical onboarding call.</strong><br>
                     <span class="checkbox-subtitle">No sales deck. You won't be subscribed to any marketing communications.</span>
                  </label>
               </div>
            </div>

            <form id="create-app-form" method="post">
               <input type="hidden" name="manifest" value='{{ manifest }}'>
               <button type="submit" class="btn-primary">Create GitHub application</button>
            </form>
         </div>
         <div class="support-section">
            <h4 class="support-title">Support</h4>
            <div class="support-links">
               <a href="https://terrateam.io/docs/" class="support-link">Docs</a>
               <a href="https://terrateam.io/slack" class="support-link">Slack</a>
               <a href="https://github.com/terrateamio/terrateam" class="support-link">GitHub</a>
               <a href="mailto:support@terrateam.io" class="support-link">Email</a>
            </div>
         </div>
      </div>
      
      <!-- Fixed help link -->
      <div class="fixed-help">
         <a href="https://terrateam.io/slack" class="fixed-help-link" target="_blank">
            Need help? Join Slack
         </a>
      </div>
      
      <script>
         // Get VCS provider from session storage and update UI
         const vcsProvider = sessionStorage.getItem('vcsProvider') || 'github';
         const vcsDisplayName = vcsProvider === 'gitlab' ? 'GitLab' : 'GitHub';
         
         // Update VCS provider references in the UI
         document.getElementById('vcs-app-name').textContent = vcsDisplayName;
         document.getElementById('vcs-app-name2').textContent = vcsDisplayName;
         document.getElementById('vcs-org-label').textContent = vcsDisplayName;
         
         // Show warning for GitLab since it's not fully implemented yet
         if (vcsProvider === 'gitlab') {
            const setupCard = document.querySelector('.setup-card');
            const warningDiv = document.createElement('div');
            warningDiv.className = 'warning-box';
            warningDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 1rem; margin: 1rem 0; color: #856404;';
            warningDiv.innerHTML = '<strong>⚠️ Note:</strong> GitLab App creation is not yet implemented in this setup wizard. You will need to manually create a GitLab application. <a href="https://docs.gitlab.com/ee/integration/oauth_provider.html" target="_blank">See GitLab OAuth documentation</a>.';
            setupCard.insertBefore(warningDiv, setupCard.querySelector('.form-section'));
         }
         
         document.getElementById('create-app-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const orgInput = document.getElementById('vcs-org');
            const onboardingInput = document.getElementById('onboarding-call');
            
            const orgValue = orgInput.value.trim();
            const onboardingValue = onboardingInput.checked;
            
            // Get user data and tunnel config from session storage
            const firstName = sessionStorage.getItem('firstName') || '';
            const lastName = sessionStorage.getItem('lastName') || '';
            const email = sessionStorage.getItem('email') || '';
            const tunnelConfig = sessionStorage.getItem('tunnelConfig') || '{}';
            const sessionId = sessionStorage.getItem('sessionId') || '';
            
            // Create URL with form data that will be passed back after GitHub app creation
            const currentManifest = JSON.parse('{{{ manifest }}}');
            const formData = new URLSearchParams();
            if (firstName) formData.append('firstName', firstName);
            if (lastName) formData.append('lastName', lastName);
            if (email) formData.append('email', email);
            formData.append('onboardingCall', onboardingValue);
            formData.append('tunnelConfig', tunnelConfig);
            if (sessionId) formData.append('sessionId', sessionId);
            
            // Update the redirect_url in the manifest to include our form data
            const updatedManifest = {...currentManifest};
            const baseRedirectUrl = updatedManifest.redirect_url;
            updatedManifest.redirect_url = `${baseRedirectUrl}?${formData.toString()}`;
            
            // Update the manifest input with our modified version
            document.querySelector('input[name="manifest"]').value = JSON.stringify(updatedManifest);
            
            // Create GitHub app - construct proper URL based on organization input
            const baseUrl = '{{ baseCreateAppUrl }}';
            if (orgValue) {
               // Insert the organization into the URL
               this.action = baseUrl.replace('/settings/apps/new', `/organizations/${orgValue}/settings/apps/new`);
            } else {
               // Use base URL for personal account
               this.action = baseUrl;
            }
            this.submit();
         });
      </script>
   </body>
</html>
